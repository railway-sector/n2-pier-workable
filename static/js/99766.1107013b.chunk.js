"use strict";(self.webpackChunkn2_pier_workable=self.webpackChunkn2_pier_workable||[]).push([[99766],{657:(e,t,i)=>{i.d(t,{Y:()=>n});var s=i(30726),r=i(50346);class n{constructor(e,t){this._textures=e,this.loadPromise=null,this._disposed=!1;const i=this._textures.acquire(t);(0,r.$X)(i)?(i.then(e=>{this._disposed?(0,s.Gz)(e):this._textureRef=e}),this.loadPromise=i):this._textureRef=i}dispose(){this._textureRef=(0,s.Gz)(this._textureRef),this._disposed=!0}get glTexture(){return null!=this._textureRef?this._textureRef.glTexture:null}}},10231:(e,t,i)=>{i.d(t,{i:()=>s});class s{constructor(e,t,i,s){this.toMapSpace=e,this.transform=t,this.obb=i,this.geometry=s}}},11941:(e,t,i)=>{var s,r;i.d(t,{D:()=>r,f:()=>s}),function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(s||(s={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(r||(r={}))},14303:(e,t,i)=>{i.d(t,{A:()=>m});var s,r=i(35143),n=i(42553),o=i(53084),a=i(62754),l=i(46053),c=(i(81806),i(76460),i(85842)),h=i(17707),d=i(37546),u=i(65215),p=i(9956);let m=s=class extends n.A{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,i,s){if(s.layer?.spatialReference&&!s.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,p.canProjectWithoutEngine)(e.spatialReference,s.layer.spatialReference))return void(s?.messages&&s.messages.push(new a.A("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:s.layer.spatialReference,context:s})));const r=new u.A;(0,p.projectPolygon)(e,r,s.layer.spatialReference),t[i]=r.toJSON(s)}else t[i]=e.toJSON(s);delete t[i].spatialReference}clone(){return new s({geometry:(0,o.o8)(this.geometry),type:this.type})}};(0,r._)([(0,l.MZ)({type:u.A}),(0,d.P)()],m.prototype,"geometry",void 0),(0,r._)([(0,h.K)(["web-scene","portal-item"],"geometry")],m.prototype,"writeGeometry",null),(0,r._)([(0,l.MZ)({type:["clip","mask","replace"],nonNullable:!0}),(0,d.P)()],m.prototype,"type",void 0),m=s=(0,r._)([(0,c.$)("esri.layers.support.SceneModification")],m)},21479:(e,t,i)=>{i.d(t,{f:()=>a});var s=i(20664),r=i(482),n=i(14556),o=i(80963);function a(e,t,i,a){const l=(0,r.Tp)(t,a);if(null==l)return!1;const c=l.source.spatialReferenceId,h=l.dest.spatialReferenceId;if(c===h&&c!==r.rz.UNKNOWN||(0,o.aI)(t,a))return i[0]=1,i[1]=1,i[2]=1,!0;if(c===r.rz.SPHERICAL_ECEF){const t=(0,s.l)(e),o=t/Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=t/n.$O.radius;if(h===r.rz.WEB_MERCATOR)return i[0]=o*a,i[1]=o*a,i[2]=1,!0;if(h===r.rz.WGS84||h===r.rz.CGCS2000){const e=r.iE;return i[0]=e*o*a,i[1]=e*a,i[2]=1,!0}}else if(c===r.rz.PLATE_CARREE){if(h===r.rz.WGS84||h===r.rz.CGCS2000)return i[0]=r.iE,i[1]=r.iE,i[2]=1,!0;if(h===r.rz.WEB_MERCATOR){const t=e[1]/n.$O.radius;return i[0]=1,i[1]=1/Math.cos(t),i[2]=1,!0}}return!1}},35493:(e,t,i)=>{i.d(t,{e:()=>v});var s=i(35143),r=i(91967),n=i(54099),o=i(76460),a=i(46053),l=(i(81806),i(47249),i(85842)),c=i(34761),h=i(13191),d=i(20664),u=i(9392),p=i(79115),m=i(2413),f=i(78315),g=i(95225),y=i(15255),_=i(29808),b=i(3112);let v=class extends(n.A.EventedMixin(r.A)){constructor(e){super(e),this._tmpEvent=new y.L,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new _.n(this.view.state.viewingMode),this._intersector.options.store=b.o.MIN,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,i,s){const r=this._renderCoordsHelper,n=(0,d.i)(M,e,t,i);if(!r.toRenderCoords(n,s,n))return o.A.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,h=a.fullExtent,u=null!=h&&Number.isFinite(h.xmin)&&Number.isFinite(h.xmax)&&Number.isFinite(h.ymin)&&Number.isFinite(h.ymax)&&Number.isFinite(h.zmin)&&Number.isFinite(h.zmax)?new g.H(h.zmin,h.zmax):a.elevationRange;if(null==u)return null;const p=a.elevationOffset,m=u.elevationRangeMin+p,f=u.elevationRangeMax+p,y=r.setAltitude(x,f,n),_=r.setAltitude(C,m,n);return l.reset(y,_,this.view.state.camera),c.intersect(l,null,y,_,null,!0),l.results.min.getIntersectionPoint(n)?r.getAltitude(n):null}getSphereElevationBounds(e,t){return(0,p.z)(e,t,E,this._renderSR),this._layerElevationSource.getElevationRange(E)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new g.H(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,m.Ie)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,m.Ie)(t);for(const i of e)this._expandExtent(i,t)}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,c.I0)(w,e.quaternion),w[12]=e.center[0],w[13]=e.center[1],w[14]=e.center[2];const s=e.halfSize;for(let r=0;r<8;++r)M[0]=1&r?s[0]:-s[0],M[1]=2&r?s[1]:-s[1],M[2]=4&r?s[2]:-s[2],(0,d.t)(M,M,w),this._renderCoordsHelper.fromRenderCoords(M,M,i),(0,m.fT)(t,M,t)}};(0,s._)([(0,a.MZ)({constructOnly:!0})],v.prototype,"layerElevationSource",void 0),(0,s._)([(0,a.MZ)({constructOnly:!0})],v.prototype,"intersectionHandler",void 0),(0,s._)([(0,a.MZ)({constructOnly:!0})],v.prototype,"view",void 0),(0,s._)([(0,a.MZ)()],v.prototype,"spatialReference",null),v=(0,s._)([(0,l.$)("esri.views.3d.layers.i3s.LayerElevationProvider")],v);const w=(0,h.vt)(),E=(0,f.f)(0,0,0,0),M=(0,u.vt)(),x=(0,u.vt)(),C=(0,u.vt)()},55002:(e,t,i)=>{i.d(t,{d:()=>s});class s{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}}},79115:(e,t,i)=>{i.d(t,{z:()=>a});var s=i(15941),r=i(9392),n=i(482),o=i(14556);function a(e,t,i,s){if(null==t||null==s)return!1;const r=(0,n.Tp)(t,s);if(null==r?.projector)return!1;if(r.projector===n.pO)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;const{source:a,dest:h,projector:d}=r;if(h.spatialReferenceId===n.rz.WEB_MERCATOR){const t=n.w5[a.spatialReferenceId][n.rz.WGS84];return null!=t&&(t(e,0,c,0),(0,n.s7)(c,0,i,0),i[3]=l(c[1],e[2],e[3],o.$O.radius),!0)}if(a.spatialReferenceId!==n.rz.WGS84&&a.spatialReferenceId!==n.rz.CGCS2000||h.spatialReferenceId!==n.rz.PLATE_CARREE){d(e,0,i,0);const t=a.metersPerUnit??1,s=h.metersPerUnit??1;i[3]=e[3]*t/s}else{const t=n.w5[a.spatialReferenceId][n.rz.SPHERICAL_ECEF],s=n.w5[n.rz.SPHERICAL_ECEF][n.rz.PLATE_CARREE];let r=e[3];null!=t&&null!=s&&(r=l(e[1],e[2],e[3],o.$O.radius)),d(e,0,i,0),i[3]=r}return!0}function l(e,t,i,s){const r=s+t;if(r<s/2||i>r)return Number.MAX_VALUE;const n=Math.abs(h*e)+Math.asin(i/r);return n>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(n)}const c=(0,r.vt)(),h=(0,s.kU)(1)},83491:(e,t,i)=>{i.d(t,{w:()=>h});var s=i(35143),r=i(54901),n=i(50346),o=i(68134),a=i(46053),l=(i(81806),i(76460),i(47249),i(85842)),c=i(47700);const h=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,c.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,r.hA)(()=>e.abort())),await(0,o.C_)(()=>this.view.defaultsFromMap?.heightModelInfoReady,t),(0,n.Te)(t);const i=(0,c.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,s._)([(0,a.MZ)()],t.prototype,"view",void 0),(0,s._)([(0,a.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,s._)([(0,l.$)("esri.views.3d.layers.LayerView3D")],t),t}},91196:(e,t,i)=>{i.d(t,{A:()=>m});var s=i(35143),r=i(91967),n=i(54099),o=i(5632),a=i(76460),l=i(30726),c=i(91291),h=i(46053),d=(i(81806),i(47249),i(85842)),u=i(19451),p=i(90992);let m=class extends(o.A.IdentifiableMixin(c.A.EsriPromiseMixin(n.A.EventedMixin(r.A)))){get spatialReferenceSupported(){return!0}constructor(e){super(e),this._updatingHandles=new u.U,this.layer=null,this.parent=null}initialize(){this.when().catch(e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer?.title||"no title";a.A.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e)}})}destroy(){this._updatingHandles=(0,l.pR)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return this.destroyed||!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get updateSuspended(){return this.suspended}get visible(){return!0===this.layer?.visible}set visible(e){this._overrideIfSome("visible",e)}get visibleAtCurrentScale(){return!0}get visibleAtCurrentTimeExtent(){const e=this.view.timeExtent,t=this.layer?.visibilityTimeExtent;return!e||!t||!e.intersection(t).isEmpty}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&this.parent&&!this.parent.suspended&&this.view?.ready&&(0,p.g7)(e)&&this.visibleAtCurrentScale&&this.visibleAtCurrentTimeExtent||!1}getSuspendInfo(){const e=this.parent?.suspended?this.parent.suspendInfo:{};this.view?.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0);const t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return(0,p.g7)(t)&&this.visibleAtCurrentScale||(e.outsideScaleRange=!0),this.visibleAtCurrentTimeExtent||(e.outsideVisibilityTimeExtent=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"spatialReferenceSupported",null),(0,s._)([(0,h.MZ)()],m.prototype,"view",void 0),(0,s._)([(0,h.MZ)()],m.prototype,"fullOpacity",null),(0,s._)([(0,h.MZ)()],m.prototype,"layer",void 0),(0,s._)([(0,h.MZ)()],m.prototype,"parent",void 0),(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"suspended",null),(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"suspendInfo",null),(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"legendEnabled",null),(0,s._)([(0,h.MZ)({type:Boolean,readOnly:!0})],m.prototype,"updating",null),(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"updatingProgress",null),(0,s._)([(0,h.MZ)()],m.prototype,"updateSuspended",null),(0,s._)([(0,h.MZ)()],m.prototype,"visible",null),(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),(0,s._)([(0,h.MZ)({readOnly:!0})],m.prototype,"visibleAtCurrentTimeExtent",null),m=(0,s._)([(0,d.$)("esri.views.layers.LayerView")],m)},97048:(e,t,i)=>{i.d(t,{Ir:()=>f,_b:()=>h,sQ:()=>d,xb:()=>u});var s=i(76460),r=i(68930),n=i(9392),o=i(12016),a=i(9956),l=i(14487),c=i(11941);class h{constructor(e,t,i,s,r,n){this.layout=e,this.interleavedVertexData=t,this.indices=i,this.hasColors=s,this.hasModifications=r,this.positionData=n}}class d{constructor(e,t,i,s,r,n,o){this.componentOffsets=e,this.featureIds=t,this.anchorIds=i,this.anchors=s,this.transformedGeometry=r,this.globalTrafo=n,this.obb=o}}class u extends o.B{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,i,s){const r={context:e,modifications:f(t,i,s),isGeodetic:s.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,t){const i=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:i},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const p=new r.A({deallocator:null}),m=(0,n.vt)();function f(e,t,i){p.clear();let r=1/0,n=1/0,o=-1/0,h=-1/0,d=!1;for(const f of t){const e="clip"===f.type?c.D.Inside:"mask"===f.type?c.D.Outside:c.D.Replace,t=f.geometry;let u=e=>e;if(t.spatialReference){if(!(0,a.canProjectWithoutEngine)(t.spatialReference,i)){s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}u=e=>((0,l.F)(e,t.spatialReference,m,i),m)}else t.hasZ||(m[2]=0,u=e=>(m[0]=e[0],m[1]=e[1],m));d=d||e===c.D.Outside,p.push(e),p.push(t.rings.length);for(const i of t.rings){p.push(i.length);for(const e of i){const t=u(e);p.push(t[0]),p.push(t[1]),p.push(t[2]),r=Math.min(r,t[0]),n=Math.min(n,t[1]),o=Math.max(o,t[0]),h=Math.max(h,t[1])}}}if(null!=e)if(d){const t=1e-4;p.push(c.D.Inside),p.push(2),p.push(4),p.push(r-t),p.push(n-t),p.push(0),p.push(o+t),p.push(n-t),p.push(0),p.push(o+t),p.push(h+t),p.push(0),p.push(r-t),p.push(h+t),p.push(0),p.push(4),p.push(e[0]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[3]),p.push(0),p.push(e[0]),p.push(e[3]),p.push(0)}else p.push(c.D.Outside),p.push(1),p.push(4),p.push(e[0]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[3]),p.push(0),p.push(e[0]),p.push(e[3]),p.push(0);p.push(c.D.Finished);const u=new Float64Array(p.length);for(let s=0;s<p.length;++s)u[s]=p.at(s);return u}},99766:(e,t,i)=>{i.r(t),i.d(t,{default:()=>we});var s=i(35143),r=i(50076),n=i(81806),o=i(76460),a=i(30726),l=i(68134),c=i(52394),h=i(46053),d=(i(47249),i(85842)),u=i(63919),p=i(44680),m=i(34761),f=i(13191),g=i(4336),y=i(20664),_=i(9392),b=i(55855),v=i(34111),w=i(5809),E=i(21479),M=i(14487),x=i(2413),C=i(88105),R=i(28586),A=i(14303),T=i(12482),P=i(64465),O=i(97048),S=i(65768);class I extends S.P{constructor(e,t,i,s,r,n,o){super(e,0,0,0,t),this.nodesCached=i,this.vboMB=s,this.textureMB=r,this.vboMBCached=n,this.textureMBCached=o}}var U=i(57662),L=i(83491),H=i(75228),F=i(35493),N=i(83490),V=i(93345);const j={[R.El.Points]:null,[R.El.Lines]:null,[R.El.LineStrip]:null,[R.El.Triangles]:V.WR.TRIANGLES,[R.El.TriangleStrip]:V.WR.TRIANGLE_STRIP,[R.El.NotSet]:null},k={[R._N.Opaque]:N.sf.Opaque,[R._N.Mask]:N.sf.Mask,[R._N.Blend]:N.sf.Blend},z={[R.TJ.Back]:N.s2.Back,[R.TJ.Front]:N.s2.Front,[R.TJ.None]:N.s2.None,[R.TJ.NotSet]:N.s2.Back},B={[R.Nt.WrapYBit]:{s:V.pF.CLAMP_TO_EDGE,t:V.pF.REPEAT},[R.Nt.WrapXBit]:{s:V.pF.REPEAT,t:V.pF.CLAMP_TO_EDGE},[R.Nt.WrapXy]:{s:V.pF.REPEAT,t:V.pF.REPEAT},[R.Nt.None]:{s:V.pF.CLAMP_TO_EDGE,t:V.pF.CLAMP_TO_EDGE},[R.Nt.NotSet]:{s:V.pF.CLAMP_TO_EDGE,t:V.pF.CLAMP_TO_EDGE}},D={[R.LU.U8]:1,[R.LU.I8]:1,[R.LU.U16]:2,[R.LU.I16]:2,[R.LU.U32]:4,[R.LU.I32]:4,[R.LU.F32]:4,[R.LU.F64]:8,[R.LU.Utf8String]:1,[R.LU.NotSet]:1};var G=i(39356),Z=i(45270),W=i(3112),$=i(82805),J=i(50248),q=i(48168);class X{constructor(e){this.type=J.d.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerViewUid=e.uid}intersect(e,t,i,s,r,n){if(e.options.filteredLayerViewUids.includes(this.layerView.uid))return;const o=e.results,a=e.options.store===W.o.ALL,l=this.layerView.view.stage.renderView.componentObjectCollection,c=new q.JG(n,e.options.normalRequired);this.layerView.objects.forEach(r=>{r.visible&&r.intersectionGeometry&&l.intersect(r,i,s,e.tolerance,null,c,(r,n,l,c)=>{if(n>=0){if(null!=t&&!t(i,s,n))return;const r=e=>{const t=new Z.kV(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));e.set(this.type,t,n,l)};if(this.isGround&&(null==o.ground.distance||n<o.ground.distance)&&r(o.ground),e.options.isFiltered)return;if((null==o.min.distance||n<o.min.distance)&&r(o.min),(null==o.max.distance||n>o.max.distance)&&r(o.max),a){const t=new $.i(e.ray);r(t),e.results.all.push(t)}}})})}_createTiles3DGraphic(e,t){return new G.A({layer:e,sourceLayer:e,attributes:t})}}var K,Q,Y=i(95225),ee=i(42136),te=i(59231),ie=i(10231),se=i(16449),re=i(55002),ne=i(91555),oe=i(657),ae=i(97808),le=i(81148),ce=i(50468),he=i(25672),de=i(96897),ue=i(66470),pe=i(52757),me=i(91196),fe=i(90992),ge=i(79196),ye=i(75569);(Q=K||(K={}))[Q.API=1]="API",Q[Q.VerboseAPI=2]="VerboseAPI",Q[Q.Error=3]="Error";class _e{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.textureMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function be(e){return Math.round(e/1048.576)/1e3}let ve=class extends((0,L.w)(me.A)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._compressionTracker=new ge.c,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=U.sv.WithoutRasterImage,this._applySSAO=!(0,n.A)("disable-feature:im-ssao"),this._shadeNormals=!!(0,n.A)("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}get hasModifications(){return this._modifications&&this._modifications.length>0}initialize(){if(this._dbgFlags.add(K.Error),this._dbg(K.VerboseAPI,"Tiles3DLayerView3D initialize() called"),this._updatingHandles.add(()=>this.layer.modifications,()=>this._loadModifications(),l.Vh),!this._canProjectWithoutEngine())throw new r.A("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=(0,H.Bk)(this).then(e=>{this._wasmLayerId=e,this._intersectionHandler=new X(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(e)),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),l.Vh),this._updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),l.Vh),this._elevationProvider=new F.e({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,e=>this._onRemoveFromCache(e));this._memCache=t,this.addHandles([(0,l.wB)(()=>this.layer.elevationInfo,e=>this._elevationInfoChanged(e))]),this._suspendedHandle=(0,l.wB)(()=>this.suspended,e=>this._wasm?.setEnabled(this,!e),l.Vh)});this.addResolvingPromise(e)}destroy(){this._dbg(K.VerboseAPI,"Tiles3DLayerView3D destroy() called"),(0,H.r8)(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(e=>this.freeObject(e)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=(0,a.pR)(this._memCache),this._updatingHandles=(0,a.pR)(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=(0,O.Ir)(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=(0,x.vt)();this._layerClippingArea=(0,ee.k)(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=(0,c._)(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach(t=>{const i=this._collection.getMaterial(t);i.commonMaterialParameters.hasSlicePlane=e,i.commonMaterialParameters.cullFace=e?N.s2.None:this._initialCullFace.get(t)})}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,(0,T.M7)(e))}get _obbs(){return this.objects.map(e=>this._collection.getComponentObb(e))}get _wasm(){return(0,H.pw)(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach(t=>{t.isVisible&&(e+=t.usedMemory)}),e}get unloadedMemory(){return 0}get cachedMemory(){let e=0;return this._lyrHandleToObjects.forEach(t=>{t.isVisible||(e+=t.usedMemory)}),e}get visibleAtCurrentScale(){return(0,fe.E5)(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,i=0,s=0,r=0,n=0;return this._lyrHandleToObjects.forEach(o=>{o.isVisible?(e+=o.textureMemoryUsage,t+=o.vboMemoryUsage,r++):(i+=o.textureMemoryUsage,s+=o.vboMemoryUsage,n++)}),new I(this.usedMemory,r,n,be(t),be(e),be(s),be(i))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===P.RT.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return(0,T.M7)(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new Y.H(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((e,t)=>e.concat(t.components),new Array)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||null==e)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const i=(0,_.ci)(t.desc.origin),s=new Array,r=new Map,n=new _e;n.handle=e.handle,this._lyrHandleToObjects.set(e.handle,n);const o=this.view.basemapTerrain.spatialReference;let a,l;if("global"===this.view.viewingMode){const e=(0,f.vt)();(0,w.l)(v.fv,i,e,o),a=(0,u.z0)((0,p.vt)(),e),l=(0,u.B8)((0,p.vt)(),a)}else a=p.zK,l=p.zK;const c=(0,f.vt)();(0,m.Tl)(c,c,i);const h=(0,m.sC)((0,_.vt)(),c);let d=null;const x=(0,_.vt)();if(t.desc.obb){const e=t.desc.obb.quaternion;d=new te.ab(t.desc.obb.center,t.desc.obb.halfSize,(0,g.fA)(e[0],e[1],e[2],e[3]))}for(let u=0;u<t.desc.prims.length;u++){const e=t.desc.prims[u];if(this._dbg(K.VerboseAPI,JSON.stringify(e)),null==j[e.ptype]||null==t.data){this._dbg(K.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+e.ptype+"). Skipping primitive.");continue}const c=t.desc?.materials&&null!=e.materialId?t.desc.materials[e.materialId]:null,m=null!=c?c.lightingModel:R.EF.Unlit,{positionView:f,positionAttr:g,normalsView:v,normalsAttr:w,colorAttr:A,texCoord0Attr:T,indicesView:P}=this.getBufferViews(e,t.data.buffer,a);if(null==g||null==f||null==P)continue;const O=new se.$(null!=A,T?ae.I.Default:ae.I.None,null!=v,this._shadeNormals,this._applySSAO),S=g.data.length/g.size,I=(e,t)=>!e||e.data.length/e.size===S||(this._dbg(K.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!I(T,"numTexcoord")||!I(A,"numColors")||!I(w,"normals"))continue;const U=(0,se.h)(O);if(null!=d?d=d.clone():(d=(0,te.OX)(g),(0,y.f)(x,d.center,i),d.center=x),a!==p.zK)for(let t=0;t<f.count;t++)f.getVec(t,x),(0,y.o)(x,x,a),f.setVec(t,x);const L=U.createBuffer(g.data.length);if((0,pe.zC)(ue.r.POSITION,g,null,null,L,0),null!=T){const e=L.getField(ue.r.UV0,C.gH);(0,pe.Ue)(T,e,0)}null!=A&&(0,pe.zC)(ue.r.COLOR,g,null,null,L,0),null!=w&&(0,pe.zC)(ue.r.NORMALCOMPRESSED,w,null,null,L,0);const H=new Uint32Array([0,P.typedBuffer.length]),F={vertices:{data:L.buffer,count:L.byteLength/U.stride,layoutParameters:O},positionData:{positions:f.typedBuffer,indices:P.typedBuffer},indices:P.typedBuffer,componentOffsets:H};n.cpuMemoryUsage+=f.count,n.cpuMemoryUsage+=P.count;const V=this.view.renderSpatialReference,B=(0,_.vt)(),D=[1,1,1];(0,E.f)(h,V,D,o)||this._dbg(K.Error,"Unsupported coordinate system for IM overlay"),(0,M.F)(h,V,B,o);const G=this._collection.createObject(new ie.i((0,b.fA)(B[0],B[1],D[0],D[1]),new re.d(h,l),d,F));c&&this._collection.updateMaterial(G,e=>{e.baseColor=c.baseColorFactor,e.usePBR=m===R.EF.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(c.baseColorTex,t,r,n),e.usePBR&&(e.mrrFactors=[c.metallicFactor,c.roughnessFactor,0],e.emissiveBaseColor=c.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(c.metalTex,t,r,n),e.emissionTexture=this._getTexture(c.emissiveTex,t,r,n),e.occlusionTexture=this._getTexture(c.occlusionTex,t,r,n),e.normalTexture=this._getTexture(c.normalTex,t,r,n)),e.objectOpacity=0,e.alphaDiscardMode=N.sf.Mask;const i=[];e.baseColorTexture&&i.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&i.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&i.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&i.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&i.push(e.normalTexture.loadPromise);const o=Promise.all(i);s.push(o),o.then(()=>{e.alphaDiscardMode=k[c.alphaMode],e.objectOpacity=1,n.textureMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(n.textureMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,n.textureMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,n.textureMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,n.textureMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)}),e.commonMaterialParameters.doubleSided=c.isDoubleSided,e.commonMaterialParameters.cullFace=c.faceCulling?z[c.faceCulling]:N.s2.Back,this._initialCullFace.set(G,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=ne.d0.All,e.textureAlphaCutoff=c.alphaCutoff??ye.Q,e.alphaDiscardMode=k[c.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=(0,le.V)(this.view.spatialReference)}),n.components.push(G),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(G)}if(await Promise.all(s),r.forEach(e=>{n.textures.push(e)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n),{memUsageBytes:n.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach(t=>{e.textures.forEach(e=>{this._stage.removeTexture(e)}),this._collection.destroyObject(t),this._initialCullFace.delete(t)})}setRenderableVisibility(e,t,i){if(this._memCache){for(let s=0;s<i;++s){const i=e[s],r=t[s];if(!r)continue;const n=this._lyrHandleToObjects.get(i);n&&(this._visibleGeometryChanged(),n.isVisible=r,n.components.forEach(e=>{this._collection.setObjectVisibility(e,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))}),this._memCache.pop(`${i}`))}for(let s=0;s<i;++s){const i=e[s],r=t[s];if(r)continue;const n=this._lyrHandleToObjects.get(i);n&&(this._visibleGeometryChanged(),n.isVisible=r,n.components.forEach(e=>{this._collection.setObjectVisibility(e,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))}),this._memCache.put(`${i}`,n))}}}_getTexture(e,t,i,s){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const o=t.desc.images[e?.imageId];if(r=i.get(o),!r&&o){const a=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,l=!!o.mipCount||a>1,c=B[e.wrapMode??R.Nt.None];let h=o.alpha?4:3;const d=new Uint8Array(t.data.buffer,o.data.byteOffset,o.data.byteCount);let u=null,p=null,m=null;switch(o.format){case R.h7.Raw:o.pixelFormat===R.CP.R8?(u=d,h=1,p=""):o.pixelFormat===R.CP.Rgb8?(u=d,h=3,p=""):o.pixelFormat===R.CP.Rgba8&&(u=d,h=4,p="");break;case R.h7.Dxt1:u=d,h=3,p=N.JS.DDS_ENCODING;break;case R.h7.Dxt5:u=d,h=4,p=N.JS.DDS_ENCODING;break;case R.h7.Basis:u=d,h=3,p=N.JS.KTX2_ENCODING;break;case R.h7.Png:p="image/png",m=document.createElement("img");break;case R.h7.Jpeg:p="image/jpeg",m=document.createElement("img");break;case R.h7.Etc2:p="image/ktx",m=document.createElement("img");break;case R.h7.Astc:this._dbg(K.Error,"Astc texture not supported");break;case R.h7.Pvrtc:this._dbg(K.Error,"Pvrtc texture not supported")}if(m&&p){const e=new Blob([d],{type:p});m.src=URL.createObjectURL(e),u=m}if(u&&null!=p){const e=(0,n.A)("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:e=>{e&&e>0&&(s.textureMemoryUsage-=e)}}:void 0;r=new de.g(u,{mipmap:l,maxAnisotropy:a,encoding:p,wrap:c,components:h,compressionOptions:e,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.addTexture(r),i.set(o,r)}}}return r?new oe.Y(this.view.stage.renderView.textures,r.id):null}getBufferViews(e,t,i){let s,r,n,o,a,l,c,h=null;for(let u=0;u<e.atrbs.length;u++){const c=e.atrbs[u],p=c.view,m=void 0,f=p.byteOffset+p.byteCount,g=p.byteCount/D[p.type],y=[...Array(g).keys()].map(e=>e);try{switch(c.sem){case R.eN.Position:3!==p.ncomp||p.type!==R.LU.F32?this._dbg(K.Error,"[Unsupported Feature] Unsupported view for Position ("+p+")"):(s=new C.xs(t,p.byteOffset,m,f),r=new ce.n(s.typedBuffer,y,3));break;case R.eN.Normal:if(3!==p.ncomp||p.type!==R.LU.F32)this._dbg(K.Error,"[Unsupported Feature] Unsupported view for Normal ("+p+")");else{const e=new C.xs(t,p.byteOffset,m,f),s=(0,he._l)(e.typedBuffer,i);a=new C.Qt(s),l=new ce.n(a.typedBuffer,y,2)}break;case R.eN.TexCoord:2!==p.ncomp||p.type!==R.LU.F32?this._dbg(K.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+p+")"):void 0===o&&(o=new ce.n(new C.gH(t,p.byteOffset,m,f).typedBuffer,y,2));break;case R.eN.Color:4===p.ncomp?(p.type===R.LU.F32&&(h=new C.Eq(t,p.byteOffset,m,f)),p.type===R.LU.U8&&(h=new C.XP(t,p.byteOffset,m,f)),p.type===R.LU.U16&&(h=new C.Uz(t,p.byteOffset,m,f))):3===p.ncomp&&(p.type===R.LU.F32&&(h=new C.xs(t,p.byteOffset,m,f)),p.type===R.LU.U8&&(h=new C.eI(t,p.byteOffset,m,f)),p.type===R.LU.U16&&(h=new C.nS(t,p.byteOffset,m,f))),null==h?this._dbg(K.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+p+")"):n=new ce.n(h.typedBuffer,y,p.ncomp);break;case R.eN.FeatureIndex:break;default:this._dbg(K.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(d){this._dbg(K.VerboseAPI,"Error Creating buffer ("+d+"). Skipping vertex attribute.")}}if(e.index){const i=e.index.view,s=void 0,r=i.byteOffset+i.byteCount;switch(e.index.view.type){case R.LU.U16:c=new C.h(t,i.byteOffset,s,r);break;case R.LU.U32:c=new C.P(t,i.byteOffset,s,r);break;case R.LU.U8:default:this._dbg(K.Error,"[Unsupported Feature] index type not supported ("+i.type+").")}}if(null==c&&null!=s){const e=s.count;if(e<65535){const t=new Uint16Array(e);c=new C.h(t)}else{const t=new Uint32Array(e);c=new C.P(t)}for(let t=0;t<e;t++)c.set(t,t)}return{positionView:s,positionAttr:r,colorAttr:n,texCoord0Attr:o,indicesView:c,normalsView:a,normalsAttr:l}}_loadModifications(){if(this.removeHandles("modifications"),null==this.layer.modifications)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange(()=>e,()=>this._modifications=e.toArray(),l.Vh),"modifications")}_onRemoveFromCache(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===K.Error?o.A.getLogger(this).error(t):o.A.getLogger(this).warn(t))}};(0,s._)([(0,h.MZ)({type:[A.A]})],ve.prototype,"_modifications",void 0),(0,s._)([(0,h.MZ)()],ve.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,s._)([(0,h.MZ)()],ve.prototype,"layer",void 0),(0,s._)([(0,h.MZ)({readOnly:!0})],ve.prototype,"visibleAtCurrentScale",null),(0,s._)([(0,h.MZ)()],ve.prototype,"elevationOffset",null),ve=(0,s._)([(0,d.$)("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],ve);const we=ve}}]);
//# sourceMappingURL=99766.1107013b.chunk.js.map